# 2025-08-13 (수) 작업 로그

## 문제 요약
- 증상: `GET http://localhost:3005/ 500 (Internal Server Error)`
- 범위: 홈(`/`) 진입 시에만 500, `/analysis` 등 서브 라우트는 정상
- 원인: SSR 단계에서 클라이언트 전용 훅/상태 사용으로 인한 크래시

## 근본 원인 분석
- `src/components/layout/Navigation.tsx`가 `usePathname`(Next.js 클라이언트 훅)과 Zustand 스토어를 사용하면서도 클라이언트 컴포넌트 지정(`"use client"`)이 없었음
- `Navigation`이 레이아웃/페이지에서 SSR 시점에 렌더링되며 서버에서 실행 → 런타임 충돌로 500 발생
- 타입/널 가드 미흡으로 프로덕션 빌드 시 에러가 추가로 발생하여 서버 기동에 영향을 줄 가능성 존재

## 적용한 수정 사항
1) 클라이언트 컴포넌트 지정
   - `src/components/layout/Navigation.tsx` 최상단에 `"use client"` 추가
   - `src/components/layout/Layout.tsx` 최상단에 `"use client"` 추가

2) 타입/널 가드 보강 (빌드 안정화)
   - `src/app/history/page.tsx`: `timestamp`/`emotion`/`cbtFeedback` 널 가드 추가 및 타입 안전한 집계
   - `src/app/page.tsx`: `SafeTimeDisplay`에서 `timestamp?` 허용 및 기본 표시('-')
   - `src/components/analysis/AdvancedEmotionDashboard.tsx`: `timestamp` 널 가드, 감정 집계 키 보강
   - `src/types/emotion.ts`: `EmotionAnalysis.mediaType`에 `'multimodal'` 포함
   - `src/utils/emotion.ts`: `EmotionState`에 맞춰 `surprised` 색/그라데이션/조언 보강
   - `src/modules/stores/uiStore.ts`: `surprised` 색상 추가 및 안전한 기본값 반환

## 검증 절차
- 개발/프로덕션 빌드 및 실행
  - `npm run build` → 타입체크/정적 페이지 생성 완료
  - `npm run start` → 3005 포트 기동 확인
- 엔드포인트 확인
  - `/` 500 재현 종료, 정상 HTML 응답 확인
  - `/analysis`도 200 OK

## 추가 권고 사항
- 클라이언트 훅(`usePathname`, `window`, `localStorage` 등) 사용 파일은 반드시 `"use client"` 선언
- 상태/데이터 필드(특히 `timestamp`, `emotion`, `cbtFeedback`)는 옵셔널 처리 및 널 가드 유지
- API(3000 포트) 연동은 백엔드 포트/엔드포인트 일치 필요
  - `NEXT_PUBLIC_API_URL` 확인: `http://localhost:3000/api`
  - 프론트/백엔드 엔드포인트 경로를 한쪽 기준으로 통일

## 변경 파일 목록
- `src/components/layout/Navigation.tsx`
- `src/components/layout/Layout.tsx`
- `src/app/history/page.tsx`
- `src/app/page.tsx`
- `src/components/analysis/AdvancedEmotionDashboard.tsx`
- `src/modules/stores/uiStore.ts`
- `src/types/emotion.ts`
- `src/utils/emotion.ts`

## 요약
- 홈 500은 SSR에서 클라이언트 훅 사용으로 발생 → `"use client"` 지정으로 해결
- 빌드 안정성을 위해 널 가드/타입 보강 실행
- 현재 홈/서브 라우트 정상 동작. API 연동 이슈는 별도 정합성 정리 필요